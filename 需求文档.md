# AI教师系统 - 需求文档

## 1. 项目概述

### 1.1 项目背景
AI教师系统旨在为全国中小学生提供智能化的学习辅导服务，通过整合各年级电子教材和大语言模型技术，为学生提供精准、及时的问题解答服务。

### 1.2 项目目标
- 帮助中小学生解决学习过程中的各类问题
- 提供多种交互方式（文字、语音、图片、文件）
- 覆盖全国各省份、各年级的教材体系
- 提供便捷的访问方式（微信小程序、Web端）

### 1.3 项目范围
- **用户端**：微信小程序、Web页面
- **服务端**：后端API服务
- **AI能力**：集成腾讯元宝、阿里通义千问、豆包、DeepSeek等大模型

## 2. 技术架构

### 2.1 技术栈选型
| 模块 | 技术栈 | 说明 |
|------|--------|------|
| 后端框架 | Spring Boot 3.x (基于Java 17) | 主框架 |
| ORM框架 | MyBatis-Plus | 数据库操作 |
| 数据库 | MySQL 8.0+ | 主数据库 |
| 缓存 | Redis | 会话、缓存 |
| 对象存储 | 阿里云OSS/腾讯云COS | 文件、图片存储 |
| 消息队列 | RabbitMQ/RocketMQ | 异步处理 |
| 微信小程序 | 微信小程序原生/uni-app | 移动端 |
| Web前端 | Vue 3 + Element Plus | PC端 |

### 2.2 系统架构图
```
┌─────────────────────────────────────────────────────────┐
│                       用户层                              │
│  ┌──────────────────┐      ┌──────────────────┐        │
│  │   微信小程序      │      │    Web页面       │        │
│  │  (原生/uni-app)   │      │  (Vue 3)        │        │
│  └──────────────────┘      └──────────────────┘        │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    网关层 (Gateway)                       │
│         - 统一鉴权  - 限流  - 日志  - 路由               │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                      服务层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │用户服务  │  │问答服务  │  │教材服务  │             │
│  └──────────┘  └──────────┘  └──────────┘             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │文件服务  │  │AI服务    │  │消息服务  │             │
│  └──────────┘  └──────────┘  └──────────┘             │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    数据层                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │  MySQL   │  │  Redis   │  │   OSS    │             │
│  └──────────┘  └──────────┘  └──────────┘             │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                  第三方服务层                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │腾讯元宝  │  │阿里通义  │  │豆包/DeepSeek│           │
│  └──────────┘  └──────────┘  └──────────┘             │
│  ┌──────────┐  ┌──────────┐                            │
│  │微信登录  │  │语音识别  │                            │
│  └──────────┘  └──────────┘                            │
└─────────────────────────────────────────────────────────┘
```

## 3. 功能需求

### 3.1 用户管理模块

#### 3.1.1 微信小程序登录
- **功能描述**：用户通过微信授权快速登录
- **输入**：微信授权code
- **输出**：用户信息、登录token
- **业务规则**：
  - 首次登录自动创建用户账号
  - 绑定微信openid
  - 生成JWT token

#### 3.1.2 Web扫码登录
- **功能描述**：Web端显示二维码，用户使用微信扫码登录
- **流程**：
  1. Web端请求生成登录二维码
  2. 展示二维码（含唯一ticket）
  3. 用户微信扫码
  4. 小程序端确认登录
  5. Web端轮询/WebSocket获取登录状态
  6. 登录成功，返回token
- **业务规则**：
  - 二维码有效期：5分钟
  - 支持取消登录
  - 一次性使用

#### 3.1.3 用户信息管理
- 查看个人信息（昵称、头像、年级、省份等）
- 编辑个人信息
- 设置学习信息（年级、学科偏好）

### 3.2 问答交互模块

#### 3.2.1 多模态提问
- **文本输入**
  - 支持富文本编辑
  - 支持数学公式输入（LaTeX）
  - 最大长度：2000字
  
- **图片上传**
  - 支持格式：JPG、PNG、WEBP
  - 单张最大：5MB
  - 单次最多：9张
  - 支持OCR识别题目
  
- **文件上传**
  - 支持格式：PDF、Word、Excel、PPT
  - 单个最大：20MB
  - 单次最多：3个
  
- **语音输入**
  - 支持格式：MP3、WAV、M4A
  - 最大时长：60秒
  - 自动语音转文字（ASR）

#### 3.2.2 问题分类
- **年级选择**：小学1-6年级、初中1-3年级、高中1-3年级
- **省份选择**：全国31个省市自治区
- **学科选择**：语文、数学、英语、物理、化学、生物、历史、地理、政治
- **问题类型**：题目讲解、知识点解释、学习方法、其他

#### 3.2.3 AI回答
- **功能描述**：调用大模型API，结合教材知识库生成答案
- **回答展示**：
  - 支持Markdown格式
  - 支持数学公式渲染
  - 支持分步骤讲解
  - 支持图文混排
  - 流式输出（打字机效果）
  
- **回答优化**：
  - 基于RAG（检索增强生成）技术
  - 从教材知识库检索相关内容
  - 结合学生年级和省份调整难度
  - 提供知识点关联

#### 3.2.4 对话历史
- 保存所有对话记录
- 支持按时间、学科、年级筛选
- 支持收藏重要对话
- 支持导出对话记录（PDF）

#### 3.2.5 追问功能
- 在当前对话基础上继续提问
- 保持上下文连贯性
- 最多支持10轮对话

### 3.3 教材管理模块

#### 3.3.1 教材库管理（管理端）
- **教材录入**
  - 按省份、年级、学科、教材版本分类
  - 支持批量上传教材文件
  - 支持章节目录结构
  
- **教材解析**
  - PDF/Word自动解析为文本
  - 图片OCR识别
  - 知识点标注
  
- **向量化处理**
  - 将教材内容分段
  - 生成向量embeddings
  - 存储到向量数据库

#### 3.3.2 知识库检索
- 基于用户问题检索相关教材内容
- 语义相似度匹配
- 返回最相关的3-5个片段

### 3.4 AI模型管理模块

#### 3.4.1 多模型接入
- **支持模型**：
  - 腾讯元宝（Hunyuan）
  - 阿里通义千问（Qwen）
  - 字节豆包（Doubao）
  - DeepSeek
  
- **统一接口**：
  - 定义统一的AI调用接口
  - 适配器模式实现各模型对接
  - 支持动态切换模型

#### 3.4.2 模型选择策略
- 管理员配置默认模型
- 根据问题类型自动选择模型
- 支持用户手动选择模型（可选）
- 模型降级策略（主模型失败时切换备用模型）

#### 3.4.3 Prompt工程
- 设计系统Prompt模板
- 结合教材知识库内容
- 针对不同年级调整语言风格
- 引导模型提供分步骤解答

### 3.5 文件管理模块

#### 3.5.1 文件上传
- 支持多种文件格式
- 文件格式校验
- 病毒扫描
- 上传至对象存储（OSS）

#### 3.5.2 文件处理
- 图片：压缩、OCR识别
- PDF：文本提取、图片提取
- 音频：语音转文字
- Office文档：文本提取

#### 3.5.3 文件管理
- 文件列表查看
- 文件删除
- 文件下载
- 存储空间管理

### 3.6 系统管理模块（管理端）

#### 3.6.1 用户管理
- 用户列表查看
- 用户信息编辑
- 用户禁用/启用
- 用户统计分析

#### 3.6.2 问答审核
- 敏感问题预警
- 问答质量抽查
- 用户反馈处理
- 违规内容处理

#### 3.6.3 系统配置
- AI模型配置（API Key等）
- 文件上传限制配置
- 问答次数限制配置
- 敏感词配置

#### 3.6.4 数据统计
- 用户增长趋势
- 问答量统计（按时间、年级、学科）
- 高频问题分析
- 系统性能监控

## 4. 非功能需求

### 4.1 性能需求
- **响应时间**：
  - 普通接口：< 500ms
  - AI回答接口：< 5s（首字响应 < 2s）
  - 文件上传：根据文件大小，进度实时反馈
  
- **并发量**：
  - 支持1000+ QPS
  - 支持10000+ DAU
  
- **可用性**：
  - 系统可用性：99.9%
  - 支持弹性扩容

### 4.2 安全需求
- **认证授权**：
  - JWT token认证
  - token过期时间：7天
  - 支持token刷新
  
- **数据安全**：
  - 敏感信息加密存储
  - HTTPS传输
  - SQL注入防护
  - XSS攻击防护
  
- **内容安全**：
  - 敏感词过滤
  - 图片内容审核
  - 问答内容审核

### 4.3 兼容性需求
- **微信小程序**：兼容微信7.0+
- **Web浏览器**：Chrome、Safari、Firefox、Edge最新版本
- **移动端H5**：iOS 12+、Android 8+

### 4.4 可扩展性需求
- 支持新增AI模型
- 支持新增教材版本
- 支持扩展更多问答类型
- 模块化设计，便于功能扩展

## 5. 数据库设计

### 5.1 核心表结构

#### 5.1.1 用户表（user）
```sql
CREATE TABLE `user` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
  `openid` VARCHAR(64) UNIQUE NOT NULL COMMENT '微信openid',
  `unionid` VARCHAR(64) COMMENT '微信unionid',
  `nickname` VARCHAR(50) COMMENT '昵称',
  `avatar` VARCHAR(255) COMMENT '头像URL',
  `gender` TINYINT DEFAULT 0 COMMENT '性别：0未知 1男 2女',
  `phone` VARCHAR(11) COMMENT '手机号',
  `province_code` VARCHAR(10) COMMENT '省份编码',
  `grade` VARCHAR(10) COMMENT '年级：primary_1-6, middle_1-3, high_1-3',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0禁用 1正常',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_openid (`openid`),
  INDEX idx_unionid (`unionid`)
) COMMENT='用户表';
```

#### 5.1.2 对话表（conversation）
```sql
CREATE TABLE `conversation` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '对话ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `title` VARCHAR(100) COMMENT '对话标题',
  `province_code` VARCHAR(10) COMMENT '省份编码',
  `grade` VARCHAR(10) COMMENT '年级',
  `subject` VARCHAR(20) COMMENT '学科',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0删除 1正常',
  `is_favorite` TINYINT DEFAULT 0 COMMENT '是否收藏：0否 1是',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_id (`user_id`),
  INDEX idx_create_time (`create_time`)
) COMMENT='对话表';
```

#### 5.1.3 消息表（message）
```sql
CREATE TABLE `message` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '消息ID',
  `conversation_id` BIGINT NOT NULL COMMENT '对话ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `role` VARCHAR(20) NOT NULL COMMENT '角色：user/assistant',
  `content_type` VARCHAR(20) NOT NULL COMMENT '内容类型：text/image/file/audio',
  `content` TEXT COMMENT '消息内容',
  `files` JSON COMMENT '附件列表',
  `ai_model` VARCHAR(50) COMMENT '使用的AI模型',
  `tokens` INT COMMENT '消耗的token数',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_conversation_id (`conversation_id`),
  INDEX idx_user_id (`user_id`)
) COMMENT='消息表';
```

#### 5.1.4 教材表（textbook）
```sql
CREATE TABLE `textbook` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '教材ID',
  `name` VARCHAR(100) NOT NULL COMMENT '教材名称',
  `province_code` VARCHAR(10) NOT NULL COMMENT '省份编码',
  `grade` VARCHAR(10) NOT NULL COMMENT '年级',
  `subject` VARCHAR(20) NOT NULL COMMENT '学科',
  `version` VARCHAR(50) NOT NULL COMMENT '教材版本：人教版、苏教版等',
  `semester` TINYINT COMMENT '学期：1上 2下',
  `cover_url` VARCHAR(255) COMMENT '封面图',
  `file_url` VARCHAR(255) COMMENT '教材文件URL',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0禁用 1正常',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_province_grade_subject (`province_code`, `grade`, `subject`)
) COMMENT='教材表';
```

#### 5.1.5 教材内容表（textbook_content）
```sql
CREATE TABLE `textbook_content` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '内容ID',
  `textbook_id` BIGINT NOT NULL COMMENT '教材ID',
  `chapter` VARCHAR(100) COMMENT '章节',
  `section` VARCHAR(100) COMMENT '小节',
  `content` TEXT COMMENT '内容',
  `page_number` INT COMMENT '页码',
  `knowledge_points` JSON COMMENT '知识点列表',
  `vector_id` VARCHAR(100) COMMENT '向量ID（向量数据库中的ID）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_textbook_id (`textbook_id`)
) COMMENT='教材内容表';
```

#### 5.1.6 文件表（file）
```sql
CREATE TABLE `file` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '文件ID',
  `user_id` BIGINT NOT NULL COMMENT '上传用户ID',
  `file_name` VARCHAR(255) NOT NULL COMMENT '文件名',
  `file_type` VARCHAR(50) NOT NULL COMMENT '文件类型',
  `file_size` BIGINT NOT NULL COMMENT '文件大小（字节）',
  `file_url` VARCHAR(500) NOT NULL COMMENT '文件URL',
  `thumbnail_url` VARCHAR(500) COMMENT '缩略图URL（图片）',
  `extracted_text` TEXT COMMENT '提取的文本内容',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0删除 1正常',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_id (`user_id`)
) COMMENT='文件表';
```

#### 5.1.7 扫码登录表（qrcode_login）
```sql
CREATE TABLE `qrcode_login` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '登录ID',
  `ticket` VARCHAR(100) UNIQUE NOT NULL COMMENT '登录票据',
  `qrcode_url` VARCHAR(500) NOT NULL COMMENT '二维码URL',
  `status` TINYINT DEFAULT 0 COMMENT '状态：0待扫码 1已扫码 2已确认 3已取消 4已过期',
  `user_id` BIGINT COMMENT '用户ID（确认后）',
  `expire_time` DATETIME NOT NULL COMMENT '过期时间',
  `scan_time` DATETIME COMMENT '扫码时间',
  `confirm_time` DATETIME COMMENT '确认时间',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_ticket (`ticket`),
  INDEX idx_expire_time (`expire_time`)
) COMMENT='扫码登录表';
```

#### 5.1.8 系统配置表（system_config）
```sql
CREATE TABLE `system_config` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '配置ID',
  `config_key` VARCHAR(100) UNIQUE NOT NULL COMMENT '配置键',
  `config_value` TEXT COMMENT '配置值',
  `config_desc` VARCHAR(255) COMMENT '配置描述',
  `config_type` VARCHAR(20) DEFAULT 'string' COMMENT '配置类型：string/number/json',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT='系统配置表';
```

### 5.2 省份年级字典

#### 省份编码
```
11: 北京市, 12: 天津市, 13: 河北省, 14: 山西省, 15: 内蒙古
21: 辽宁省, 22: 吉林省, 23: 黑龙江
31: 上海市, 32: 江苏省, 33: 浙江省, 34: 安徽省, 35: 福建省, 36: 江西省, 37: 山东省
41: 河南省, 42: 湖北省, 43: 湖南省, 44: 广东省, 45: 广西, 46: 海南省
50: 重庆市, 51: 四川省, 52: 贵州省, 53: 云南省, 54: 西藏
61: 陕西省, 62: 甘肃省, 63: 青海省, 64: 宁夏, 65: 新疆
```

#### 年级编码
```
primary_1-6: 小学1-6年级
middle_1-3: 初中1-3年级
high_1-3: 高中1-3年级
```

## 6. 接口设计

### 6.1 认证接口

#### 6.1.1 小程序登录
```
POST /api/auth/miniapp/login
Request:
{
  "code": "微信授权code",
  "userInfo": {
    "nickname": "昵称",
    "avatar": "头像URL"
  }
}
Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "JWT token",
    "userInfo": {
      "id": 1,
      "nickname": "昵称",
      "avatar": "头像",
      "grade": "middle_1",
      "provinceCode": "11"
    }
  }
}
```

#### 6.1.2 生成登录二维码
```
POST /api/auth/qrcode/generate
Response:
{
  "code": 200,
  "data": {
    "ticket": "唯一票据",
    "qrcodeUrl": "二维码图片URL",
    "expireTime": "2025-11-21T10:05:00"
  }
}
```

#### 6.1.3 扫码确认登录
```
POST /api/auth/qrcode/confirm
Request:
{
  "ticket": "票据",
  "confirm": true
}
Response:
{
  "code": 200,
  "message": "确认成功"
}
```

#### 6.1.4 轮询登录状态
```
GET /api/auth/qrcode/status?ticket=xxx
Response:
{
  "code": 200,
  "data": {
    "status": 2, // 0待扫码 1已扫码 2已确认 3已取消 4已过期
    "token": "JWT token（已确认时返回）",
    "userInfo": {...}
  }
}
```

### 6.2 用户接口

#### 6.2.1 获取用户信息
```
GET /api/user/info
Response:
{
  "code": 200,
  "data": {
    "id": 1,
    "nickname": "昵称",
    "avatar": "头像",
    "grade": "middle_1",
    "provinceCode": "11",
    "provinceName": "北京市"
  }
}
```

#### 6.2.2 更新用户信息
```
PUT /api/user/info
Request:
{
  "nickname": "新昵称",
  "grade": "middle_2",
  "provinceCode": "11"
}
```

### 6.3 问答接口

#### 6.3.1 创建对话
```
POST /api/conversation/create
Request:
{
  "provinceCode": "11",
  "grade": "middle_1",
  "subject": "数学"
}
Response:
{
  "code": 200,
  "data": {
    "conversationId": 123
  }
}
```

#### 6.3.2 发送消息
```
POST /api/conversation/{conversationId}/message
Request:
{
  "contentType": "text", // text/image/file/audio
  "content": "问题内容",
  "files": [
    {
      "fileId": 1,
      "fileUrl": "文件URL"
    }
  ],
  "aiModel": "qwen" // 可选，不传使用默认模型
}
Response (流式):
{
  "code": 200,
  "data": {
    "messageId": 456,
    "content": "回答内容（流式输出）",
    "relatedKnowledge": [
      {
        "textbookName": "数学七年级上册",
        "chapter": "第一章",
        "content": "相关知识点"
      }
    ]
  }
}
```

#### 6.3.3 获取对话列表
```
GET /api/conversation/list?page=1&size=20&subject=数学
Response:
{
  "code": 200,
  "data": {
    "total": 100,
    "list": [
      {
        "id": 123,
        "title": "二次方程求解",
        "subject": "数学",
        "grade": "middle_1",
        "lastMessage": "最后一条消息",
        "createTime": "2025-11-21T10:00:00"
      }
    ]
  }
}
```

#### 6.3.4 获取对话详情
```
GET /api/conversation/{conversationId}
Response:
{
  "code": 200,
  "data": {
    "id": 123,
    "title": "二次方程求解",
    "messages": [
      {
        "id": 1,
        "role": "user",
        "content": "问题",
        "contentType": "text",
        "files": [],
        "createTime": "2025-11-21T10:00:00"
      },
      {
        "id": 2,
        "role": "assistant",
        "content": "回答",
        "aiModel": "qwen",
        "createTime": "2025-11-21T10:00:05"
      }
    ]
  }
}
```

### 6.4 文件接口

#### 6.4.1 获取上传签名
```
GET /api/file/upload-signature?fileName=xxx&fileType=image
Response:
{
  "code": 200,
  "data": {
    "uploadUrl": "OSS上传地址",
    "signature": "签名",
    "fileId": 789
  }
}
```

#### 6.4.2 上传完成通知
```
POST /api/file/upload-complete
Request:
{
  "fileId": 789,
  "fileUrl": "最终文件URL"
}
```

#### 6.4.3 文件处理
```
POST /api/file/process
Request:
{
  "fileId": 789,
  "processType": "ocr" // ocr/extract_text/speech_to_text
}
Response:
{
  "code": 200,
  "data": {
    "extractedText": "识别的文本内容"
  }
}
```

### 6.5 教材接口

#### 6.5.1 获取教材列表
```
GET /api/textbook/list?provinceCode=11&grade=middle_1&subject=数学
Response:
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "name": "数学七年级上册",
      "version": "人教版",
      "coverUrl": "封面",
      "semester": 1
    }
  ]
}
```

#### 6.5.2 搜索教材内容
```
POST /api/textbook/search
Request:
{
  "query": "二次方程",
  "provinceCode": "11",
  "grade": "middle_1",
  "subject": "数学"
}
Response:
{
  "code": 200,
  "data": [
    {
      "textbookName": "数学七年级上册",
      "chapter": "第一章",
      "content": "相关内容片段",
      "similarity": 0.95
    }
  ]
}
```

### 6.6 管理端接口

#### 6.6.1 用户管理
```
GET /api/admin/user/list?page=1&size=20
POST /api/admin/user/{userId}/disable
POST /api/admin/user/{userId}/enable
```

#### 6.6.2 教材管理
```
POST /api/admin/textbook/create
PUT /api/admin/textbook/{id}
DELETE /api/admin/textbook/{id}
POST /api/admin/textbook/{id}/upload-content
```

#### 6.6.3 系统配置
```
GET /api/admin/config/list
PUT /api/admin/config
```

#### 6.6.4 数据统计
```
GET /api/admin/statistics/overview
GET /api/admin/statistics/user-growth
GET /api/admin/statistics/question-trend
```

## 7. AI模型接入方案

### 7.1 统一接口设计
```java
public interface AIModelService {
    /**
     * 流式对话
     */
    Flux<String> streamChat(ChatRequest request);
    
    /**
     * 普通对话
     */
    ChatResponse chat(ChatRequest request);
    
    /**
     * 多模态对话（支持图片）
     */
    ChatResponse multimodalChat(MultimodalChatRequest request);
}

public class ChatRequest {
    private String systemPrompt;  // 系统提示词
    private List<Message> messages;  // 历史消息
    private String model;  // 模型名称
    private Double temperature;  // 温度参数
    private Integer maxTokens;  // 最大token数
}
```

### 7.2 各模型适配器

#### 7.2.1 腾讯元宝适配器
```java
@Service
public class HunyuanModelService implements AIModelService {
    @Value("${ai.hunyuan.app-id}")
    private String appId;
    
    @Value("${ai.hunyuan.secret-key}")
    private String secretKey;
    
    // 实现接口方法
}
```

#### 7.2.2 阿里通义适配器
```java
@Service
public class QwenModelService implements AIModelService {
    @Value("${ai.qwen.api-key}")
    private String apiKey;
    
    // 实现接口方法
}
```

#### 7.2.3 豆包适配器
```java
@Service
public class DoubaoModelService implements AIModelService {
    // 实现接口方法
}
```

#### 7.2.4 DeepSeek适配器
```java
@Service
public class DeepSeekModelService implements AIModelService {
    // 实现接口方法
}
```

### 7.3 模型选择策略
```java
@Service
public class AIModelRouter {
    @Autowired
    private Map<String, AIModelService> modelServiceMap;
    
    public AIModelService selectModel(String modelName) {
        // 根据模型名称选择对应的服务
        return modelServiceMap.get(modelName);
    }
    
    public AIModelService selectModelByStrategy(String subject, String grade) {
        // 根据策略选择模型
        // 例如：理科用DeepSeek，文科用Qwen
        if (Arrays.asList("数学", "物理", "化学").contains(subject)) {
            return modelServiceMap.get("deepseek");
        } else {
            return modelServiceMap.get("qwen");
        }
    }
}
```

### 7.4 RAG实现方案

#### 7.4.1 向量数据库选型
推荐使用：
- **Milvus**：开源、高性能
- **Elasticsearch**：成熟、易用
- **Pinecone**：云服务（国外）
- **阿里云向量检索服务**

#### 7.4.2 RAG流程
```
1. 用户提问
   ↓
2. 问题embedding（向量化）
   ↓
3. 向量数据库检索相关教材内容（Top-K）
   ↓
4. 构建Prompt：
   System: 你是一位中学数学老师...
   Context: 以下是相关的教材内容：[检索到的内容]
   User: [用户问题]
   ↓
5. 调用大模型API
   ↓
6. 返回答案
```

#### 7.4.3 Embedding模型
- **文本向量化**：
  - 阿里通义 text-embedding-v1
  - OpenAI text-embedding-ada-002
  - 开源模型：bge-large-zh（中文）

## 8. 部署方案

### 8.1 服务器配置（初期）
- **应用服务器**：2台（4核8G）
- **数据库服务器**：1台（4核16G）
- **Redis服务器**：1台（2核4G）
- **对象存储**：阿里云OSS/腾讯云COS
- **向量数据库**：可选云服务

### 8.2 部署架构
```
                      [负载均衡 - Nginx/ALB]
                              |
              +---------------+---------------+
              |                               |
         [应用服务器1]                    [应用服务器2]
         Spring Boot                    Spring Boot
              |                               |
              +---------------+---------------+
                              |
                    +---------+---------+
                    |         |         |
                 [MySQL]   [Redis]   [OSS]
```

### 8.3 CI/CD流程
```
Git Push → GitLab/GitHub → Jenkins/GitLab CI → 构建Docker镜像 
  → 推送镜像仓库 → 部署到服务器 → 健康检查
```

### 8.4 监控方案
- **应用监控**：Spring Boot Actuator + Prometheus + Grafana
- **日志监控**：ELK（Elasticsearch + Logstash + Kibana）
- **告警**：AlertManager + 钉钉/企业微信

## 9. 开发计划

### 9.1 项目阶段划分

#### 第一阶段：基础框架搭建（2周）
- 搭建Spring Boot项目框架
- 配置MyBatis-Plus
- 设计数据库表结构
- 实现基础工具类和公共模块

#### 第二阶段：用户认证模块（1周）
- 微信小程序登录
- Web扫码登录
- JWT token生成与验证
- 用户信息管理

#### 第三阶段：文件管理模块（1周）
- 文件上传（OSS）
- 图片OCR识别
- 语音转文字
- 文件解析

#### 第四阶段：AI模型接入（2周）
- 设计统一AI接口
- 接入腾讯元宝
- 接入阿里通义
- 接入DeepSeek/豆包
- 实现流式输出

#### 第五阶段：教材知识库（2周）
- 教材管理功能
- 教材内容解析
- 向量化处理
- RAG实现

#### 第六阶段：问答核心功能（2周）
- 对话管理
- 多模态提问
- AI回答生成
- 对话历史

#### 第七阶段：小程序开发（2周）
- 页面设计与开发
- 对接后端API
- 测试优化

#### 第八阶段：Web端开发（2周）
- 页面设计与开发
- 扫码登录
- 对接后端API

#### 第九阶段：管理后台（1周）
- 用户管理
- 教材管理
- 系统配置
- 数据统计

#### 第十阶段：测试与优化（2周）
- 功能测试
- 性能测试
- 安全测试
- Bug修复
- 性能优化

**总计：约17周（4个月）**

### 9.2 人员配置建议
- 后端工程师：2人
- 前端工程师：1人（Web + 小程序）
- UI设计师：1人
- 测试工程师：1人
- 产品经理：1人（兼项目经理）

## 10. 风险与应对

### 10.1 技术风险
| 风险 | 影响 | 应对措施 |
|------|------|----------|
| AI模型调用超时/失败 | 用户无法获得回答 | 实现多模型降级策略、请求重试机制 |
| 向量检索不准确 | 回答质量下降 | 优化embedding模型、调整检索策略 |
| 大文件上传失败 | 用户体验差 | 分片上传、断点续传 |
| 并发量过大 | 系统崩溃 | 限流、缓存、弹性扩容 |

### 10.2 业务风险
| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 教材版权问题 | 法律风险 | 使用公开教材、购买授权 |
| 内容安全问题 | 监管风险 | 敏感词过滤、内容审核 |
| AI回答不准确 | 误导学生 | 人工抽查、用户反馈机制 |
| 成本过高 | 难以持续 | 使用开源模型、优化调用策略 |

### 10.3 运营风险
| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 用户增长缓慢 | 项目失败 | 推广运营、与学校合作 |
| 用户留存率低 | 活跃度低 | 优化产品体验、增加互动功能 |
| 恶意使用 | 资源浪费 | 限制调用频率、实名认证 |

## 11. 成本估算

### 11.1 开发成本
- 人员工资：按6人团队，4个月开发周期计算
- 硬件设备：开发机、测试机

### 11.2 运营成本（月度）
| 项目 | 预估费用 |
|------|----------|
| 服务器（4台） | ¥2,000 |
| 数据库 | ¥800 |
| 对象存储（1TB） | ¥300 |
| CDN流量 | ¥500 |
| AI接口调用 | ¥3,000-10,000（根据用户量） |
| 短信服务 | ¥200 |
| 域名+SSL证书 | ¥100 |
| **合计** | **¥6,900-13,900** |

### 11.3 成本优化建议
1. 初期使用云服务按量付费
2. 优化AI调用策略（缓存、去重）
3. 使用CDN减少带宽成本
4. 考虑使用开源/自部署模型降低AI成本

## 12. 附录

### 12.1 参考资料
- Spring Boot官方文档
- MyBatis-Plus官方文档
- 微信小程序开发文档
- 腾讯元宝API文档
- 阿里通义千问API文档
- DeepSeek API文档

### 12.2 术语表
- **RAG**：Retrieval-Augmented Generation，检索增强生成
- **Embedding**：向量化，将文本转换为向量表示
- **OCR**：Optical Character Recognition，光学字符识别
- **ASR**：Automatic Speech Recognition，自动语音识别
- **JWT**：JSON Web Token，一种身份认证机制
- **OSS**：Object Storage Service，对象存储服务

### 12.3 联系方式
- 项目负责人：[待填写]
- 技术负责人：[待填写]
- 产品经理：[待填写]

---

**文档版本**：v1.0  
**创建日期**：2025-11-21  
**最后更新**：2025-11-21  
**文档状态**：待评审

